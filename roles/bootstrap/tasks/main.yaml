
- name: Debug
  debug:
    msg: "Hostname is {{ ansible_hostname }} , with ip {{ vm_dataplane_ipv4 }}"

- name: Configure netplan static IP
  ansible.builtin.template:
    src: 01-netcfg.yaml.j2
    dest: /etc/netplan/01-netcfg.yaml
  notify:
    - Apply netplan

- name: Create {{ users }} and add to p4 group
  ansible.builtin.user:
    name: "{{ item }}"
    shell: /bin/bash
    groups: "{{ user_groups }}"
    append: yes
    password: "{{ 'p4-restart' | password_hash('sha512', 'mysecretsalt') }}"
    update_password: on_create
    state: present
  with_items: "{{ users }}"

- name: Set sudoers for admin_user
  ansible.builtin.copy:
    dest: /etc/sudoers.d/{{ admin_user }}
    content: |
      {{ admin_user }} ALL=(ALL) NOPASSWD: ALL
    owner: root
    group: root
    mode: 0440
    
- name: populate /etc/environment
  lineinfile:
    path: "/etc/environment"
    state: present
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value}}"
  with_items: "{{ os_environment }}"
    
- name: "Add {{ sde_path }} to $PATH if not exists"
  ansible.builtin.lineinfile:
    path: /home/{{ item }}/.bashrc
    state: present
    line: 'export PATH="$PATH:{{ sde_path }}"'
  with_items: "{{ users }}"

# add few useful shortcuts
- name: Add sde and switchp4sde aliases
  ansible.builtin.copy:
    dest: /home/{{ item }}/.bash_aliases
    content: |
      alias sde='cd $SDE'
      alias switchp4='sde && ./run_switchd.sh -p switch'
      alias iftofinoup='sudo $SDE_INSTALL/bin/veth_setup.sh'
      alias iftofinodown='sudo $SDE_INSTALL/bin/veth_teardown.sh'
    mode: "0644"
  with_items: "{{ users }}"

- name: Add 'p4' symlink to /opt/p4-sde/bf-sde-9.13.2/run_switchd.sh
  ansible.builtin.file:
    src: /opt/p4-sde/bf-sde-9.13.2/run_switchd.sh
    dest: /usr/local/bin/p4
    state: link

- name: Add p4-build utility
  ansible.builtin.copy:
    dest: "{{ sde_path }}/p4-build"
    content: "{{ lookup('file', 'p4-build.sh') }}"
    mode: "0775"
